# 乒乓球在线预约系统

一个完整的乒乓球场地在线预约平台，支持用户注册、预约管理、参与者评分等功能。

## 🎯 项目概述

本项目是一个乒乓球场地在线预约系统，用户可以通过该系统预约乒乓球台、加入他人预约、管理个人资料，并在预约完成后对其他参与者进行评分。

## ✨ 主要功能

### 用户管理
- **用户注册与登录**：支持学号注册和登录
- **个人资料管理**：可设置个人简介和乒乓球水平等级
- **个人主页**：展示用户信息和评分统计

### 预约管理
- **创建预约**：可预约今天到未来14天内的乒乓球台
- **加入预约**：可加入他人创建的预约
- **取消预约**：发起者可在开场前2小时内取消预约
- **退出预约**：参与者可在特定条件下退出预约
- **预约状态管理**：自动处理预约状态（active → completed）

### 评分系统
- **相互评分**：预约参与者可以相互评分
- **评分维度**：实力评分（1-5分）和愉悦度评分（1-5分）
- **评分统计**：显示平均分和分数分布
- **五角星显示**：平均分以五角星形式直观展示
- **分数分布图**：显示各分数段的人数占比

### 历史预约管理
- **个人评分完成即消失**：用户完成评分后，预约从个人主页消失
- **独立状态跟踪**：每个用户的评分状态独立管理
- **预约清理**：所有参与者完成评分后，预约自动删除

## 🔧 技术架构

### 前端技术
- **HTML/CSS/JavaScript**：纯前端实现，无框架依赖
- **响应式设计**：适配不同屏幕尺寸
- **本地存储**：使用localStorage管理会话

### 后端技术
- **Node.js + Express**：轻量级后端框架
- **数据持久化**：JSON文件存储，支持服务器重启数据恢复
- **RESTful API**：标准的API设计

### 核心API端点
- `/api/register` - 用户注册
- `/api/login` - 用户登录
- `/api/bookings` - 预约管理
- `/api/ratings` - 评分管理
- `/api/users/:studentId/history` - 历史预约查询

## 🚀 快速开始

### 环境要求
- Node.js 14+
- npm 或 yarn

### 安装与运行
1. 进入Express目录：
   ```bash
   cd Express
   ```

2. 安装依赖：
   ```bash
   npm install
   ```

3. 启动服务器：
   ```bash
   node server.js
   ```

4. 访问系统：
   打开浏览器访问 `http://localhost:3000`

### 测试模式
系统支持测试模式，管理员可以设置虚拟时间进行测试：
- 管理员账号：学号 `25371305`，姓名 `刘宇轩`
- 通过测试模式API设置虚拟时间

## 📋 使用说明

### 用户注册与登录
1. 访问注册页面填写学号、姓名、密码完成注册
2. 注册成功后自动登录
3. 后续可通过学号和密码登录

### 创建预约
1. 登录后进入主页
2. 选择预约日期（今天、明天、后天或具体日期）
3. 选择时间段和球台号
4. 设置最大参与人数
5. 提交预约

### 加入预约
1. 在预约列表中选择可加入的预约
2. 点击加入按钮
3. 系统自动将用户添加到参与者列表

### 评分功能
1. 预约结束后，在个人主页查看历史预约
2. 点击"为参与者评分"按钮
3. 为其他参与者进行实力和愉悦度评分
4. 评分完成后，预约从个人主页消失

## 🔄 最近重大更新

### 数据持久化功能（最新）
- **实时数据保存**：所有用户操作自动保存到本地JSON文件
- **服务器重启恢复**：服务器重启时自动加载之前的数据
- **数据完整性**：支持用户数据、预约数据、评分数据和计数器的持久化
- **错误处理**：完善的错误处理和日志记录

### 数据文件结构
```
Express/data/
├── users.json      # 用户数据
├── bookings.json   # 预约数据
├── ratings.json    # 评分数据
└── counters.json   # 计数器数据
```

### 评分系统优化
- **解决重复评分问题**：过滤掉当前用户自己，避免重复评分
- **参与者去重**：确保每个参与者只出现一次
- **相互评分机制**：支持两人相互评分

### 历史预约管理改进
- **个人评分状态跟踪**：每个用户独立跟踪评分完成状态
- **主页清理优化**：用户完成评分后预约立即从主页消失
- **预约保留机制**：预约在所有参与者完成评分后才被删除

### 用户体验提升
- **五角星评分显示**：平均分以直观的五角星形式展示
- **分数分布可视化**：显示各分数段的人数占比
- **评分状态提示**：清晰显示已评分和待评分状态

## 🎨 界面特色

### 五角星评分显示
- 平均分精确到小数点后一位
- 部分填充的五角星显示小数部分
- 直观展示评分水平

### 分数分布图
- 水平条形图显示各分数段人数
- 填充比例反映人数占比
- 清晰展示评分分布情况

### 响应式设计
- 适配桌面和移动设备
- 统一的视觉风格
- 友好的用户交互

## 📝 注意事项

1. **预约限制**：每个用户最多同时发起5个预约
2. **取消限制**：开场前2小时内不能取消预约
3. **退出限制**：开场前2小时内且参与人数为2人时不能退出
4. **评分时机**：只能对已完成的预约进行评分
5. **评分对象**：只能对其他参与者评分，不能对自己评分

## 🔮 未来规划

- 数据库持久化存储（已完成）
- 邮件通知功能
- 移动端APP开发
- 更多场地类型支持
- 社交功能增强

---

**项目维护者**：刘宇轩  
